## Миграции базы данных с Alembic

При разработке приложения модели данных SQLAlchemy постоянно меняются. Чтобы синхронизировать эти изменения со схемой базы данных, используются миграции. Alembic — это стандартный инструмент для управления миграциями в проектах на SQLAlchemy.

### 1. Установка и инициализация

#### Установка
```bash
pip install alembic
```

#### Инициализация

Выполните эту команду в корне вашего проекта. Она создаст директорию `alembic` и файл `alembic.ini`.

```bash
alembic init alembic
```

### 2. Настройка для асинхронного проекта

Нужно отредактировать два файла: `alembic.ini` и `alembic/env.py`.

#### `alembic.ini`

Раскомментируйте и укажите URL для подключения к вашей базе данных. Alembic будет использовать его для выполнения миграций.

```ini
# ...

# a-database-specific string connecting to your database.
# sqlalchemy.url = driver://user:pass@localhost/dbname
sqlalchemy.url = postgresql+asyncpg://postgres:password@postgres:5432/microservices_db

# ...
```

#### `alembic/env.py`

Это основной конфигурационный файл. Его нужно адаптировать для работы с асинхронным кодом и моделями SQLAlchemy.

1.  **Импортируйте `Base` из ваших моделей.** Alembic должен знать о метаданных ваших моделей, чтобы автоматически генерировать миграции.
2.  **Настройте асинхронное выполнение.**

Примерно так будет выглядеть измененный `env.py`:

```python
from __future__ import with_statement

import asyncio
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool
from sqlalchemy.ext.asyncio import AsyncEngine

from alembic import context

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
fileConfig(config.config_file_name)

# --- НАЧАЛО ИЗМЕНЕНИЙ ---

# 1. Импортируем базовую модель из нашего проекта
# Убедитесь, что путь импорта корректен для вашей структуры проекта
from src.models.base import Base # Предполагается, что у вас есть такой файл
from src.models import user # Импортируем все модели, чтобы они зарегистрировались в Base.metadata

# 2. Устанавливаем метаданные наших моделей как цель для автогенерации
target_metadata = Base.metadata

# --- КОНЕЦ ИЗМЕНЕНИЙ ---

def run_migrations_offline():
    """Run migrations in 'offline' mode."""
    # ... (без изменений)

def do_run_migrations(connection):
    context.configure(connection=connection, target_metadata=target_metadata)

    with context.begin_transaction():
        context.run_migrations()


async def run_migrations_online():
    """Run migrations in 'online' mode."""
    
    # --- НАЧАЛО ИЗМЕНЕНИЙ ---
    
    # 3. Используем AsyncEngine для подключения
    connectable = AsyncEngine(
        engine_from_config(
            config.get_section(config.config_ini_section),
            prefix="sqlalchemy.",
            poolclass=pool.NullPool,
            future=True,
        )
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

    await connectable.dispose()
    
    # --- КОНЕЦ ИЗМЕНЕНИЙ ---


if context.is_offline_mode():
    run_migrations_offline()
else:
    # --- НАЧАЛО ИЗМЕНЕНИЙ ---
    # 4. Запускаем асинхронную функцию
    asyncio.run(run_migrations_online())
    # --- КОНЕЦ ИЗМЕНЕНИЙ ---

```

### 3. Создание и применение миграций

#### Создание новой миграции

Каждый раз, когда вы изменяете свои модели SQLAlchemy (например, добавляете новую колонку в `src/models/user.py`), вам нужно сгенерировать новый файл миграции. Alembic сравнит состояние моделей с состоянием базы данных и создаст скрипт для обновления.

```bash
alembic revision --autogenerate -m "Add full_name to User model"
```

- `--autogenerate`: Указывает Alembic автоматически определить изменения.
- `-m "..."`: Краткое описание миграции. Это станет частью имени файла и комментарием внутри него.

Эта команда создаст новый файл в директории `alembic/versions/`, например `..._add_full_name_to_user_model.py`.

**Пример сгенерированного файла:**
```python
"""Add full_name to User model

Revision ID: 1a2b3c4d5e6f
Revises: 
Create Date: 2023-10-27 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '1a2b3c4d5e6f'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('full_name', sa.String(length=255), nullable=True))
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'full_name')
    # ### end Alembic commands ###
```

#### Применение миграции

Чтобы применить все новые миграции к базе данных, выполните команду:

```bash
alembic upgrade head
```

- `head` означает, что нужно применить все миграции до последней версии.

#### Откат миграции

Чтобы откатить последнюю миграцию, можно использовать:

```bash
alembic downgrade -1
```

Этот процесс обеспечивает контролируемое и версионируемое изменение схемы вашей базы данных, что критически важно для командной разработки и развертывания.
